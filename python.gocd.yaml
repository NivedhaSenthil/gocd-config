pipelines:
  python-build:
    group: Gauge-Python
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
    stages:
      - test:
          jobs:
            osx:
              resources:
                - darwin
                - UT
              tasks:
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - pip3 install -r requirements.txt --user
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - PATH=$HOME/Library/Python/3.6/bin:$PATH python3 build.py --test
                - exec:
                   command: touch
                   arguments:
                    - /vagrant/rollback.txt
            linux:
              elastic_profile_id: gocd-jdk-mvn-python
              tasks:
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                    - --user
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --test
            windows:
              resources:
                - new_windows
              tasks:
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --test
  python-package:
    group: Gauge-Python
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
      package:
        pipeline: python-build
        stage: test
    stages:
      - package:
          jobs:
            package:
              elastic_profile_id: gocd-jdk-mvn-python
              tasks:
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - rm -rf dist bin
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                    - --user
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --dist
              artifacts:
               - build:
                   source: bin/
               - build:
                   source: dist/
               - build:
                   source: .
                   destination: src
  python-FT:
    group: Gauge-Python
    materials:
      gauge-tests:
        git: https://github.com/getgauge/gauge-tests.git
      package:
        pipeline: python-package
        stage: package
      gauge:
        pipeline: Gauge-Package
        stage: sign
    stages:
      - FT:
          jobs:
            windows:
              resources:
                - new_windows
              environment_variables:
               JAVA_HOME: C:\Program Files\Java\jdk1.8.0_162
               GAUGE_ROOT: C:\gauge_root
              tasks:
               - fetch:
                  pipeline: Gauge-Package
                  stage: sign
                  job: windows
                  is_file: yes
                  source: test_installers/gauge-windows.x86_64.zip
               - fetch:
                  pipeline: python-package
                  stage: package
                  job: package
                  source: bin
               - fetch:
                  pipeline: python-package
                  stage: package
                  job: package
                  source: dist
               - exec:
                  command: cmd
                  arguments:
                   - /c
                   - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
               - exec:
                  command: cmd
                  arguments:
                   - /c
                   - "%GAUGE_ROOT%/gauge"
                   - uninstall
                   - python
               - exec:
                  working_directory: bin
                  command: cmd
                  arguments:
                   - /c
                   - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
               - exec:
                  working_directory: dist
                  command: cmd
                  arguments:
                   - /c
                   - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
               - exec:
                  command: cmd
                  arguments:
                   - /c
                   - "%GAUGE_ROOT%/gauge"
                   - install
               - exec:
                  command: cmd
                  arguments:
                   - /c
                   - path %PATH%;%GAUGE_ROOT% & mvn -q clean test-compile gauge:execute -Denv=ci-python -Dtags=python -DinParallel=false
            osx:
              resources:
                - darwin
                - FT
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline:  Gauge-Package
                    stage: sign
                    job: windows
                    is_file: yes
                    source: test_installers/gauge-darwin.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-darwin.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip3 install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - pip3 list
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - GAUGE_PYTHON_COMMAND=python3 PATH=/tmp/bin:$PATH mvn -q clean install -Denv=ci-python -Dnodes=2 -Dtags="python" -DinParallel=true
                - exec:
                   command: touch
                   arguments:
                    - /vagrant/rollback.txt
            linux:
              elastic_profile_id: gocd-jdk-mvn-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Package
                    stage: sign
                    job: windows
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH mvn -q clean install -Denv=ci-python -Dnodes=2 -Dtags="python" -DinParallel=true
  python-lsp-tests:
    group: Gauge-Python
    materials:
      gauge-lsp-tests:
        git: https://github.com/getgauge/gauge-lsp-tests.git
      package:
        pipeline: python-package
        stage: package
      gauge:
        pipeline: Gauge-Package
        stage: sign
    stages:
      - lsp-tests:
          jobs:
            osx:
              resources:
                - darwin
                - FT
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Package
                    stage: sign
                    job: windows
                    is_file: yes
                    source: test_installers/gauge-darwin.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-darwin.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip3 install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - GAUGE_PYTHON_COMMAND=python3 PATH=/tmp/bin:$PATH gauge run specs --env=python-wd
            linux:
              elastic_profile_id: gocd-node-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Package
                    stage: sign
                    job: windows
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge run specs --env=python-wd
            windows:
              resources:
                - new_windows
              environment_variables:
                JAVA_HOME: C:\Program Files\Java\jdk1.8.0_162
                GAUGE_ROOT: C:\gauge_root
              tasks:
                - fetch:
                    pipeline: Gauge-Package
                    stage: sign
                    job: windows
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - install
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - npm
                      - install
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - run
                      - specs
                      - --env=python-wd
  gauge-python-nightly:
    group: Nightly
    materials:
      package:
        pipeline: python-package
        stage: package
    timer:
      spec: "0 30 5 ? * MON-FRI"
      only_on_changes: yes
    stages:
      - upload:
          approval: manual
          jobs:
            build_package:
              elastic_profile_id: gocd-jdk-mvn-python
              environment_variables:
               NIGHTLY: true
              tasks:
               - fetch:
                  pipeline: python-package
                  stage: package
                  job: package
                  source: src
               - exec:
                  command: /bin/sh
                  arguments:
                   - -c
                   - rm -rf dist bin
              - exec:
                  command: pip
                  arguments:
                   - install
                   - -r
                   - requirements.txt
                   - --user
              - exec:
                  command: python
                  arguments:
                   - build.py
                   - --dist
  python-release:
    group: Gauge-Python
    materials:
      package:
        pipeline: python-package
        stage: package
    stages:
      - github:
          approval: manual
          jobs:
            release:
              elastic_profile_id: gauge-centos-all
              environment_variables:
                repoName: gauge-python
                GOPATH: /tmp
              secure_variables:
                GITHUB_TOKEN: NQJXCgXvHwzebDC27DfhkpsmjcMjRNwbguFJXdMvVXJyw5eSaKXE2EFPgji/6/ug
              tasks:
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - exec:
                   command: /bin/sh
                   working_directory: bin
                   arguments:
                    - -c
                    - (curl -sSfL https://github.com/getgauge/gauge/raw/master/build/github_release.sh | sh)
      - pypi:
          approval: manual
          jobs:
            pypi_upload:
              elastic_profile_id: gocd-jdk-mvn-python
              secure_variables:
               PYPI_USER: +A8MwngWBLI=
               PYPI_PASSWORD: Yxi7Rn1SMoD82r6ME7LaiKVwkAZcS0+j
              tasks:
               - fetch:
                  pipeline: python-package
                  stage: package
                  job: package
                  source: dist
               - exec:
                  command: pip
                  arguments:
                    - install
                    - twine
                    - --user
               - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - (file=$(ls dist/getgauge-*.tar.gz); twine upload -u $PYPI_USER -p $PYPI_PASSWORD $file)
